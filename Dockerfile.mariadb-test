FROM mariadb:10.6

# Set up environment
ENV MYSQL_ROOT_PASSWORD=testroot \
    MYSQL_DATABASE=testdb \
    MYSQL_USER=testuser \
    MYSQL_PASSWORD=testpass \
    MYSQL_INNODB_BUFFER_POOL_SIZE=256M \
    MYSQL_INNODB_LOG_FILE_SIZE=128M \
    MYSQL_MAX_CONNECTIONS=200 \
    MYSQL_INNODB_FLUSH_LOG_AT_TRX_COMMIT=2

# Copy schema and setup scripts
COPY ./testdata/schema.sql /docker-entrypoint-initdb.d/
RUN chmod -R 644 /docker-entrypoint-initdb.d/*

# Configure health check
HEALTHCHECK --interval=5s --timeout=5s --retries=20 --start-period=30s \
    CMD mysqladmin ping -u testuser -ptestpass || exit 1

# Expose port
EXPOSE 3306

# Custom startup command with optimizations
CMD ["mysqld", \
    "--character-set-server=utf8mb4", \
    "--collation-server=utf8mb4_unicode_ci", \
    "--max-allowed-packet=64M", \
    "--innodb-flush-method=O_DIRECT", \
    "--innodb-buffer-pool-size=256M", \
    "--innodb-log-file-size=128M", \
    "--max-connections=200", \
    "--innodb-flush-log-at-trx-commit=2"]
